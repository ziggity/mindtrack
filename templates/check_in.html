<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindTrack – Check In</title>
    <!-- If style.css sits beside this file -->
    <link rel="stylesheet" href="style.css" />
    <!-- If you keep it in /static, use: <link rel="stylesheet" href="static/style.css" /> -->
  </head>

  <body>
    <header class="navbar">
      <div class="brand">🧠 MindTrack</div>
      <nav class="nav-links">
        <a href="home.html">🏠 Home</a>
        <a href="dashboard.html">📊 Dashboard</a>
        <a href="journal.html">📓 Journal</a>
        <a href="check_in.html" aria-current="page">🙂 Check In</a>
        <a href="resources.html">📚 Resources</a>
        <a href="safety.html">🛟 Safety</a>
        <a href="login.html">🔑 Login</a>
        <a href="signup.html">🧾 Sign Up</a>
      </nav>
    </header>

    <section id="checkin">
      <div class="container">
        <div class="card">
          <h1>Daily Check In</h1>

          <form id="checkinForm" class="form mt-3">
            <label class="label" for="mood">Mood</label>
            <select id="mood" class="input" required>
              <option value="">Select mood</option>
              <option>🙂 Happy</option>
              <option>😐 Neutral</option>
              <option>😢 Sad</option>
              <option>😰 Stressed</option>
              <option>😟 Anxious</option>
              <option>😴 Tired</option>
            </select>

            <label class="label mt-3" for="notes">Notes</label>
            <textarea
              id="notes"
              class="input input-multiline"
              rows="4"
              placeholder="Add a note"
            ></textarea>

            <button type="submit" class="btn mt-3">Save Check In</button>
          </form>

          <h2 class="mt-4">History</h2>
          <div id="checkinList" class="checkins"></div>
        </div>
      </div>
    </section>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("checkinForm");
        const moodSelect = document.getElementById("mood");
        const notesInput = document.getElementById("notes");
        const listDiv = document.getElementById("checkinList");

        // Load + migrate ids
        let all = getAll();
        let migrated = false;
        all = all.map((it) => {
          if (!it.id) {
            it.id = genId();
            migrated = true;
          }
          return it;
        });
        if (migrated) setAll(all);

        // Render oldest -> newest
        all.forEach(renderRow);

        // Save new check in
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const mood = (moodSelect.value || "").trim();
          const notes = (notesInput.value || "").trim();
          if (!mood) return;

          const item = {
            id: genId(),
            mood,
            notes,
            date: new Date().toLocaleString(),
          };
          const current = getAll();
          current.push(item);
          setAll(current);

          renderRow(item); // append to bottom
          form.reset();
          moodSelect.focus();
        });

        // Delete (event delegation)
        listDiv.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-id]");
          if (!btn) return;
          const id = btn.getAttribute("data-id");

          const updated = getAll().filter((it) => it.id !== id);
          setAll(updated);

          const row = listDiv.querySelector(`.checkin-row[data-id="${id}"]`);
          if (row) {
            row.classList.add("fade-out");
            row.addEventListener("animationend", () => row.remove(), {
              once: true,
            });
          }
        });

        // Helpers
        function getAll() {
          try {
            return JSON.parse(localStorage.getItem("checkIns") || "[]");
          } catch {
            return [];
          }
        }
        function setAll(arr) {
          localStorage.setItem("checkIns", JSON.stringify(arr));
        }
        function genId() {
          return (
            String(Date.now()) + "-" + Math.random().toString(36).slice(2, 8)
          );
        }
        function escapeHtml(s) {
          return s.replace(
            /[&<>\"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
        }

        function renderRow(item) {
          const row = document.createElement("div");
          row.className = "checkin-row fade-in";
          row.dataset.id = item.id;

          const header = document.createElement("div");
          header.className = "checkin-header";

          const left = document.createElement("div");
          left.className = "checkin-left";
          left.innerHTML = `<strong class="checkin-date">${item.date}</strong> — <span class="checkin-mood">${item.mood}</span>`;

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "🗑️ Delete";
          delBtn.setAttribute("data-id", item.id);

          header.appendChild(left);
          header.appendChild(delBtn);

          const body = document.createElement("p");
          body.className = "checkin-notes";
          body.innerHTML = item.notes ? escapeHtml(item.notes) : "";

          row.appendChild(header);
          row.appendChild(body);

          listDiv.appendChild(row);
        }
      });
    </script>
  </body>
</html>
