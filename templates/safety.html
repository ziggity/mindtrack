<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindTrack â€“ Safety Plan</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="brand">ğŸ§  MindTrack</div>
      <nav class="nav-links">
        <a href="home.html">ğŸ  Home</a>
        <a href="dashboard.html">ğŸ“Š Dashboard</a>
        <a href="journal.html">ğŸ““ Journal</a>
        <a href="check_in.html">ğŸ™‚ Check-In</a>
        <a href="resources.html">ğŸ“š Resources</a>
        <a href="safety.html" aria-current="page">ğŸ›Ÿ Safety</a>
        <a href="login.html">ğŸ”‘ Login</a>
        <a href="signup.html">ğŸ§¾ Sign Up</a>
      </nav>
    </header>

    <!-- Safety Section -->
    <section id="safety">
      <div class="container">
        <div class="card">
          <h1>ğŸ›Ÿ Safety Plan</h1>
          <p>
            Identify your triggers, emotions, coping strategies, and people to
            reach out to.
          </p>

          <form id="safetyForm" class="form mt-3">
            <label class="label" for="triggers">Triggers</label>
            <textarea
              id="triggers"
              class="input input-multiline"
              rows="2"
              placeholder="Things that trigger stress or anxiety"
            ></textarea>

            <label class="label" for="emotions">Emotions</label>
            <textarea
              id="emotions"
              class="input input-multiline"
              rows="2"
              placeholder="Describe your current emotions"
            ></textarea>

            <label class="label" for="coping">Coping Plans</label>
            <textarea
              id="coping"
              class="input input-multiline"
              rows="2"
              placeholder="Strategies to manage your emotions"
            ></textarea>

            <label class="label" for="supports">Supports</label>
            <textarea
              id="supports"
              class="input input-multiline"
              rows="2"
              placeholder="People or resources to reach out to"
            ></textarea>

            <button type="submit" class="btn mt-3">Save Safety Plan</button>
          </form>

          <h2 class="mt-4">Saved Plans</h2>
          <div id="plansList" class="plans"></div>
        </div>
      </div>
    </section>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("safetyForm");
        const triggers = document.getElementById("triggers");
        const emotions = document.getElementById("emotions");
        const coping = document.getElementById("coping");
        const supports = document.getElementById("supports");
        const listDiv = document.getElementById("plansList");

        // Load + migrate
        let all = getAll();
        let migrated = false;
        all = all.map((p) => {
          if (!p.id) {
            p.id = genId();
            migrated = true;
          }
          return p;
        });
        if (migrated) setAll(all);
        all.forEach(renderRow);

        // Save new plan
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const data = {
            id: genId(),
            date: new Date().toLocaleString(),
            triggers: triggers.value.trim(),
            emotions: emotions.value.trim(),
            coping: coping.value.trim(),
            supports: supports.value.trim(),
          };
          if (
            !data.triggers &&
            !data.emotions &&
            !data.coping &&
            !data.supports
          )
            return;

          const current = getAll();
          current.push(data);
          setAll(current);
          renderRow(data);
          form.reset();
        });

        // Delete
        listDiv.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-id]");
          if (!btn) return;
          const id = btn.dataset.id;
          const updated = getAll().filter((p) => p.id !== id);
          setAll(updated);
          const row = listDiv.querySelector(`.plan-row[data-id="${id}"]`);
          if (row) {
            row.classList.add("fade-out");
            row.addEventListener("animationend", () => row.remove(), {
              once: true,
            });
          }
        });

        // Helpers
        function getAll() {
          try {
            return JSON.parse(localStorage.getItem("safetyPlans") || "[]");
          } catch {
            return [];
          }
        }
        function setAll(arr) {
          localStorage.setItem("safetyPlans", JSON.stringify(arr));
        }
        function genId() {
          return Date.now() + "-" + Math.random().toString(36).slice(2, 8);
        }
        function escapeHtml(s) {
          return s.replace(
            /[&<>\"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[c])
          );
        }

        function renderRow(plan) {
          const row = document.createElement("div");
          row.className = "plan-row fade-in";
          row.dataset.id = plan.id;

          const header = document.createElement("div");
          header.className = "plan-header";

          const dateEl = document.createElement("div");
          dateEl.className = "plan-date";
          dateEl.innerHTML = `<strong>${plan.date}</strong>`;

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "ğŸ—‘ï¸ Delete";
          delBtn.dataset.id = plan.id;

          header.append(dateEl, delBtn);

          const body = document.createElement("div");
          body.className = "plan-body";
          body.innerHTML = [
            plan.triggers
              ? `<p><strong>Triggers:</strong> ${escapeHtml(plan.triggers)}</p>`
              : "",
            plan.emotions
              ? `<p><strong>Emotions:</strong> ${escapeHtml(plan.emotions)}</p>`
              : "",
            plan.coping
              ? `<p><strong>Coping:</strong> ${escapeHtml(plan.coping)}</p>`
              : "",
            plan.supports
              ? `<p><strong>Supports:</strong> ${escapeHtml(plan.supports)}</p>`
              : "",
          ].join("");

          row.append(header, body);
          listDiv.appendChild(row);
        }
      });
    </script>
  </body>
</html>
